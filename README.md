To do:
* malloc calls are not protected
* implement negative return value when write or malloc fails
